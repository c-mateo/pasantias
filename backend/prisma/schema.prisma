// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
  output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
}

// ==========================================
// USUARIOS Y AUTENTICACIÓN
// ==========================================

model User {
  id              Int      @id @default(autoincrement())
  
  // Autenticación
  emailHash       String   @unique @db.VarChar(64)  // SHA256 para buscar sin desencriptar
  email           String   @db.Text                 // Encriptado (AES-256-GCM)
  password        String   @db.VarChar(255)         // Bcrypt hash
  role            UserRole @default(STUDENT)
  
  // Perfil obligatorio
  firstName       String   @db.Text                 // Encriptado
  lastName        String   @db.Text                 // Encriptado
  dni             String   @db.Text                 // Encriptado (8 dígitos)
  phone           String   @db.Text                 // Encriptado
  domicilio       String   @db.Text                 // Encriptado (calle y número)
  
  // Ubicación (plain text para filtrar)
  localidad       String   @db.VarChar(100)         // Encriptado
  provincia       String   @db.VarChar(100)         // Encriptado
  
  // Metadata
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  deletedAt       DateTime?
  anonymizedAt    DateTime?
  
  // Relaciones
  courses         Course[]                      // N-N: Usuario en múltiples carreras
  skills          Skill[]
  documents       Document[]
  drafts          ApplicationDraft[]
  applications    Application[]
  sessions        Session[]
  notifications   Notification[]
  
  @@index([emailHash])
  @@index([provincia, localidad])
}

enum UserRole {
  STUDENT
  ADMIN
}

model Session {
  id             String   @id @default(cuid())
  userId         Int
  createdAt      DateTime @default(now())
  lastActivityAt DateTime @default(now())  // Para sliding/renewal
  expiresAt      DateTime
  ipAddress      String?  @db.VarChar(45)   // IPv6 compatible
  userAgent      String?  @db.Text
  
  user           User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId])
  @@index([expiresAt])
  @@index([lastActivityAt])
}

// ==========================================
// CATÁLOGOS
// ==========================================

model Course {
  id          Int      @id @default(autoincrement())
  name        String   @unique @db.VarChar(200)
  description String?  @db.Text
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  users       User[]
}

model Skill {
  id          Int      @id @default(autoincrement())
  name        String   @unique @db.VarChar(200)
  description String?  @db.Text
  category    String?  @db.VarChar(100)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  users       User[]
  offers      Offer[]
}

model DocumentType {
  id              Int      @id @default(autoincrement())
  name            String   @unique @db.VarChar(200)
  description     String?  @db.Text
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  documents       Document[]
  requiredDocs    RequiredDocument[]
}

// ==========================================
// EMPRESAS Y OFERTAS
// ==========================================

model Company {
  id          Int      @id @default(autoincrement())
  name        String   @db.VarChar(200)
  description String?  @db.Text
  website     String?  @db.VarChar(500)
  email       String   @unique @db.VarChar(255)
  phone       String?  @db.VarChar(50)
  logo        String?  @db.VarChar(500)
  
  verified    Boolean  @default(false)
  verifiedAt  DateTime?
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  deletedAt   DateTime?
  
  offers      Offer[]
  
  @@index([verified])
  @@index([email])
}

model Offer {
  id              Int         @id @default(autoincrement())
  companyId       Int
  title           String      @db.VarChar(200)
  description     String      @db.Text
  status          OfferStatus @default(DRAFT)
  
  publishedAt     DateTime?
  expiresAt       DateTime?
  closedAt        DateTime?
  
  // Campos custom dinámicos (baja prioridad)
  customFieldsSchema Json?    // Definición de campos adicionales
  
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt
  deletedAt       DateTime?
  
  company         Company            @relation(fields: [companyId], references: [id], onDelete: Cascade)
  requiredDocs    RequiredDocument[]
  skills          Skill[]
  drafts          ApplicationDraft[]
  applications    Application[]
  
  @@index([companyId])
  @@index([status])
  @@index([status, publishedAt])
  @@index([expiresAt])
}

enum OfferStatus {
  DRAFT
  ACTIVE
  CLOSED
  EXPIRED
}

model RequiredDocument {
  offerId         Int
  documentTypeId  Int
  
  offer           Offer        @relation(fields: [offerId], references: [id], onDelete: Cascade)
  documentType    DocumentType @relation(fields: [documentTypeId], references: [id], onDelete: Restrict)
  
  draftDocuments  DraftDocument[]
  appDocuments    ApplicationDocument[]
  
  @@id([offerId, documentTypeId])
  @@index([offerId])
  @@index([documentTypeId])
}

// ==========================================
// DOCUMENTOS
// ==========================================

model Document {
  id                   Int      @id @default(autoincrement())
  userId               Int
  documentTypeId       Int
  originalName         String   @db.VarChar(255)
  
  // Path con UUID para anonimato
  // Ej: /uploads/documents/2025/11/a1b2c3d4-e5f6-7890-abcd-ef1234567890.pdf
  path                 String   @unique @db.VarChar(500)
  
  fileSize             Int?
  
  createdAt            DateTime @default(now())
  lastUsedAt           DateTime @default(now())
  scheduledForDeletion DateTime?
  
  // Integración universitaria (baja prioridad)
  // source               DocumentSource @default(USER_UPLOAD)
  externalId           String?  @db.VarChar(200)
  verifiedAt           DateTime?
  // verifiedBy           Int?
  
  user                 User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  documentType         DocumentType @relation(fields: [documentTypeId], references: [id], onDelete: Restrict)
  // verifier             User?        @relation("DocumentVerifier", fields: [verifiedBy], references: [id])
  
  draftDocuments       DraftDocument[]
  applicationDocuments ApplicationDocument[]
  
  @@index([userId])
  @@index([userId, documentTypeId])
  @@index([scheduledForDeletion])
}

// ==========================================
// BORRADORES DE POSTULACIÓN
// ==========================================

model ApplicationDraft {
  userId      Int
  offerId     Int
  
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  expiresAt   DateTime?
  
  // Valores de campos custom en draft (baja prioridad)
  customFieldsValues Json?
  
  user        User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  offer       Offer            @relation(fields: [offerId], references: [id], onDelete: Cascade)
  documents   DraftDocument[]
  
  @@id([userId, offerId])
  @@index([userId])
  @@index([offerId])
  @@index([updatedAt])
  @@index([expiresAt])
}

model DraftDocument {
  userId          Int
  offerId         Int
  documentId      Int
  documentTypeId  Int
  
  draft           ApplicationDraft @relation(fields: [userId, offerId], references: [userId, offerId], onDelete: Cascade)
  document        Document         @relation(fields: [documentId], references: [id], onDelete: Cascade)
  required        RequiredDocument @relation(fields: [offerId, documentTypeId], references: [offerId, documentTypeId])
  
  @@id([userId, offerId, documentId])
  @@unique([userId, offerId, documentTypeId])
  @@index([userId, offerId])
  @@index([documentId])
}

// ==========================================
// POSTULACIONES
// ==========================================

model Application {
  id              Int               @id @default(autoincrement())
  userId          Int
  offerId         Int
  status          ApplicationStatus @default(PENDING)
  
  appliedAt       DateTime          @default(now())
  reviewedAt      DateTime?
  finalizedAt     DateTime?
  acceptedAt      DateTime?
  rejectedAt      DateTime?
  startDate       DateTime?
  endDate         DateTime?
  feedback        String?           @db.Text
  
  // Bloqueo por cambios en requisitos
  blockReason     String?           @db.VarChar(100)
  blockedAt       DateTime?
  unblockedAt     DateTime?
  
  // Valores de campos custom (baja prioridad)
  customFieldsValues Json?          // Valores completados por usuario
  
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  
  user            User                  @relation(fields: [userId], references: [id], onDelete: Cascade)
  offer           Offer                 @relation(fields: [offerId], references: [id], onDelete: Cascade)
  documents       ApplicationDocument[]
  
  @@unique([userId, offerId])
  @@index([userId])
  @@index([offerId])
  @@index([status])
  @@index([status, updatedAt])
  @@index([appliedAt])
}

enum ApplicationStatus {
  PENDING
  REVIEWING
  BLOCKED      // Requiere acción del usuario (ej: documentos adicionales)
  ACCEPTED
  REJECTED
  CANCELLED
}

model ApplicationDocument {
  applicationId   Int
  documentId      Int
  offerId         Int
  documentTypeId  Int
  uploadedAt      DateTime @default(now())
  
  application     Application      @relation(fields: [applicationId], references: [id], onDelete: Cascade)
  document        Document         @relation(fields: [documentId], references: [id], onDelete: Cascade)
  required        RequiredDocument @relation(fields: [offerId, documentTypeId], references: [offerId, documentTypeId])
  
  @@id([applicationId, documentId])
  @@unique([applicationId, offerId, documentTypeId])
  @@index([applicationId])
  @@index([documentId])
}

// ==========================================
// NOTIFICACIONES
// ==========================================

model Notification {
  id         Int                @id @default(autoincrement())
  userId     Int
  type       NotificationType
  title      String             @db.VarChar(200)
  message    String             @db.Text
  relatedId  Int?
  
  isRead     Boolean            @default(false)
  readAt     DateTime?
  createdAt  DateTime           @default(now())
  
  user       User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId, isRead])
  @@index([userId, createdAt])
}

enum NotificationType {
  APPLICATION_SUBMITTED
  APPLICATION_ACCEPTED
  APPLICATION_REJECTED
  OFFER_PUBLISHED
  OFFER_CLOSING_SOON
  ADMIN_ANNOUNCEMENT
}