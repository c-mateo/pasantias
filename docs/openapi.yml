openapi: 3.0.3
info:
  title: Pasantias API (initial)
  version: 0.1.0
  description: |
    Initial OpenAPI specification covering the most-used public and admin endpoints.
    This file was generated from existing controllers and documentation; treat it as a living
    document — extend with more endpoints and schemas as the backend evolves.
servers:
  - url: /api
paths:
  /offers:
    get:
      summary: List offers (cursor pagination)
      parameters:
        - in: query
          name: limit
          schema:
            type: integer
        - in: query
          name: after
          schema:
            type: integer
        - in: query
          name: q
          schema:
            type: string
        - in: query
          name: sort
          schema:
            type: string
        - in: query
          name: courses
          schema:
            type: string
        - in: query
          name: companyId
          schema:
            type: integer
      responses:
        '200':
          description: Paginated list of offers
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/OfferListResponse'
  /offers/{id}:
    get:
      summary: Offer details
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: integer
      responses:
        '200':
          description: Offer detail
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/OfferDetailsResponse'
  /companies:
    get:
      summary: List companies (admin/public)
      parameters:
        - in: query
          name: limit
          schema:
            type: integer
        - in: query
          name: after
          schema:
            type: integer
      responses:
        '200':
          description: Paginated list of companies
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CompanyListResponse'
  /admin/users:
    get:
      summary: Admin — list users (cursor pagination)
      parameters:
        - in: query
          name: limit
          schema:
            type: integer
        - in: query
          name: after
          schema:
            type: integer
      responses:
        '200':
          description: Paginated list of users
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserListResponse'

  /offers/{offerId}/draft:
    get:
      summary: Get current user's draft for an offer
      parameters:
        - in: path
          name: offerId
          required: true
          schema:
            type: integer
      responses:
        '200':
          description: Draft detail
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DraftGetResponse'
        '204':
          description: No draft exists
    patch:
      summary: Save draft (custom fields)
      parameters:
        - in: path
          name: offerId
          required: true
          schema:
            type: integer
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/DraftSaveBody'
      responses:
        '200':
          description: Draft saved
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DraftSaveResponse'
    delete:
      summary: Delete draft (and its attachments)
      parameters:
        - in: path
          name: offerId
          required: true
          schema:
            type: integer
      responses:
        '204':
          description: Deleted

  /offers/{offerId}/draft/documents/{reqDocId}:
    put:
      summary: Upload a document for a required document type
      parameters:
        - in: path
          name: offerId
          required: true
          schema:
            type: integer
        - in: path
          name: reqDocId
          required: true
          schema:
            type: integer
      requestBody:
        required: true
        content:
          application/pdf:
            schema:
              type: string
              format: binary
      responses:
        '200':
          description: Document uploaded
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UploadDocumentResponse'

  /offers/{offerId}/draft/documents/{attachmentId}:
    delete:
      summary: Unlink a document attachment from a draft
      parameters:
        - in: path
          name: offerId
          required: true
          schema:
            type: integer
        - in: path
          name: attachmentId
          required: true
          schema:
            type: integer
      responses:
        '204':
          description: Deleted

  /offers/{offerId}/draft/documents/use-existing:
    post:
      summary: Link an existing user document to the draft
      parameters:
        - in: path
          name: offerId
          required: true
          schema:
            type: integer
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                documentId:
                  type: integer
              required:
                - documentId
      responses:
        '200':
          description: Document linked
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DraftAttachmentDTO'

  /offers/{offerId}/draft/submit:
    post:
      summary: Submit draft to create an application
      parameters:
        - in: path
          name: offerId
          required: true
          schema:
            type: integer
      responses:
        '200':
          description: Application submitted
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApplicationSubmitResponse'

  /my-documents:
    get:
      summary: List user documents
      responses:
        '200':
          description: List of user's documents
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MyDocumentsListResponse'

  /my-documents/{id}/download:
    post:
      summary: Download a document (returns binary PDF)
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: integer
      responses:
        '200':
          description: PDF file
          content:
            application/pdf:
              schema:
                type: string
                format: binary

components:
  securitySchemes:
    cookieAuth:
      type: apiKey
      in: cookie
      name: session
  schemas:
    CursorPagination:
      type: object
      properties:
        limit:
          type: integer
        hasNext:
          type: boolean
        next:
          type: integer
          nullable: true
    OfferDTO:
      type: object
      properties:
        id:
          type: integer
        position:
          type: string
        description:
          type: string
          nullable: true
        status:
          type: string
        vacancies:
          type: integer
        publishedAt:
          type: string
          nullable: true
    OfferListResponse:
      type: object
      properties:
        data:
          type: array
          items:
            $ref: '#/components/schemas/OfferDTO'
        pagination:
          $ref: '#/components/schemas/CursorPagination'
    OfferDetailsResponse:
      type: object
      properties:
        data:
          type: object
          properties:
            id:
              type: integer
            position:
              type: string
            company:
              type: object
              properties:
                id: { type: integer }
                name: { type: string }
    CompanyDTO:
      type: object
      properties:
        id: { type: integer }
        name: { type: string }
        email: { type: string }
        website: { type: string, nullable: true }
    CompanyListResponse:
      type: object
      properties:
        data:
          type: array
          items:
            $ref: '#/components/schemas/CompanyDTO'
        pagination:
          $ref: '#/components/schemas/CursorPagination'
    UserDTO:
      type: object
      properties:
        id: { type: integer }
        firstName: { type: string }
        lastName: { type: string }
        email: { type: string }
        role: { type: string }
    UserListResponse:
      type: object
      properties:
        data:
          type: array
          items:
            $ref: '#/components/schemas/UserDTO'
        pagination:
          $ref: '#/components/schemas/CursorPagination'

    DocumentTypeDTO:
      type: object
      properties:
        id:
          type: integer
        name:
          type: string

    DocumentDTO:
      type: object
      properties:
        id:
          type: integer
        documentType:
          $ref: '#/components/schemas/DocumentTypeDTO'
        originalName:
          type: string
        hash:
          type: object
          properties:
            sha256:
              type: string
        createdAt:
          type: string
        lastUsedAt:
          type: string

    MyDocumentsListResponse:
      type: object
      properties:
        data:
          type: array
          items:
            $ref: '#/components/schemas/DocumentDTO'
        pagination:
          $ref: '#/components/schemas/CursorPagination'

    DraftDTO:
      type: object
      properties:
        id:
          type: integer
        userId:
          type: integer
        offerId:
          type: integer
        customFieldsValues:
          type: object
          additionalProperties: true
        createdAt:
          type: string
        updatedAt:
          type: string

    DraftAttachmentDTO:
      type: object
      properties:
        id:
          type: integer
        document:
          type: object
          properties:
            id:
              type: integer
            documentTypeId:
              type: integer
            documentType:
              $ref: '#/components/schemas/DocumentTypeDTO'
            originalName:
              type: string

    DraftGetResponse:
      type: object
      properties:
        data:
          type: object
          properties:
            id:
              type: integer
            userId:
              type: integer
            offerId:
              type: integer
            attachments:
              type: array
              items:
                $ref: '#/components/schemas/DraftAttachmentDTO'

    DraftSaveBody:
      type: object
      properties:
        customFieldsValues:
          type: object
          additionalProperties: true

    DraftSaveResponse:
      type: object
      properties:
        data:
          $ref: '#/components/schemas/DraftDTO'
          
    DocumentAttachmentInfoDTO:
      type: object
      properties:
        id:
          type: integer
        documentTypeId:
          type: integer
        originalName:
          type: string
        size:
          type: integer
        hash:
          type: object
          properties:
            sha256:
              type: string

    UploadDocumentResponse:
      type: object
      properties:
        data:
          $ref: '#/components/schemas/DocumentAttachmentInfoDTO'
        links:
          type: array
          items:
            type: object
            properties:
              rel:
                type: string
              href:
                type: string
              method:
                type: string

    ApplicationSubmitResponse:
      type: object
      properties:
        data:
          type: object
          properties:
            applicationId:
              type: integer
            status:
              type: string
            appliedAt:
              type: string

    ApiError:
      type: object
      properties:
        type:
          type: string
        title:
          type: string
        status:
          type: integer
        detail:
          type: string
        meta:
          type: object
          additionalProperties: true
